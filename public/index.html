<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grand Palace Hotel</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --primary-gold: #c19b76; --primary-dark: #212529; }
    body { font-family: 'Lato', sans-serif; background-color: #f9f9f9; color: #555; }
    h1, h2, h3, h4, h5, .navbar-brand { font-family: 'Playfair Display', serif; color: var(--primary-dark); }
    
    .btn-gold { background-color: var(--primary-gold); color: white; border: none; padding: 10px 25px; transition: 0.3s; }
    .btn-gold:hover { background-color: #a08060; color: white; }
    .btn-outline-gold { border: 1px solid var(--primary-gold); color: var(--primary-gold); transition: 0.3s; }
    .btn-outline-gold:hover { background-color: var(--primary-gold); color: white; }

    .hero {
      height: 75vh;
      background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1578683010236-d716f9a3f461?w=1920') center/cover;
      display: flex; align-items: center; justify-content: center; text-align: center; color: white; margin-bottom: 50px;
    }
    .hero h1 { color: white !important; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }

    .room-card { border: none; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; height: 100%; }
    .room-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
    
    .summary-box { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: sticky; top: 100px; }
    
    /* Map Container */
    #map { height: 400px; width: 100%; border-radius: 12px; z-index: 1; }
  </style>
</head>
<body>

<div id="app">
  
  <nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top py-3">
    <div class="container">
      <a class="navbar-brand fs-3 fw-bold" href="#" @click="step=0">Grand Palace</a>
      
      <div class="d-flex gap-2">
        <button v-if="!user" class="btn btn-outline-dark btn-sm" @click="showAuthModal = true">Login / Sign Up</button>
        <div v-else class="dropdown">
           <button class="btn btn-dark btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
             <i class="bi bi-person-circle"></i> {{ user.username }}
           </button>
           <ul class="dropdown-menu">
             <li><a class="dropdown-item" href="#" @click="fetchMyBookings">My Bookings</a></li>
             <li><a class="dropdown-item" href="/admin.html" v-if="user.role==='admin'">Admin Panel</a></li>
             <li><hr class="dropdown-divider"></li>
             <li><a class="dropdown-item text-danger" href="#" @click="logout">Logout</a></li>
           </ul>
        </div>
      </div>
    </div>
  </nav>

  <div v-if="showAuthModal" class="modal d-block" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4">
        <div class="d-flex justify-content-between mb-3">
          <h4>{{ authMode === 'login' ? 'Login' : 'Sign Up' }}</h4>
          <button class="btn-close" @click="showAuthModal = false"></button>
        </div>
        
        <input v-if="authMode === 'register'" v-model="authForm.username" class="form-control mb-3" placeholder="Username">
        <input v-model="authForm.email" class="form-control mb-3" placeholder="Email">
        <input v-model="authForm.password" type="password" class="form-control mb-3" placeholder="Password">
        
        <button class="btn btn-gold w-100 mb-3" @click="authenticate">
          {{ authMode === 'login' ? 'Login' : 'Create Account' }}
        </button>
        
        <p class="text-center small">
          {{ authMode === 'login' ? "Don't have an account?" : "Already have an account?" }}
          <a href="#" @click="authMode = authMode === 'login' ? 'register' : 'login'">
            {{ authMode === 'login' ? 'Sign Up' : 'Login' }}
          </a>
        </p>
      </div>
    </div>
  </div>

  <div v-if="step === 0">
    <div class="hero">
      <div>
        <h6 class="text-uppercase letter-spacing-2 mb-3 text-white">Welcome to Paradise</h6>
        <h1 class="display-3 mb-5">Experience True Luxury</h1>
        <button class="btn btn-gold btn-lg" @click="step = 1">Book Your Stay</button>
      </div>
    </div>
    
    <div class="container mb-5">
      <div class="text-center mb-4">
        <h2>Our Location</h2>
        <p class="text-muted">Located in the heart of the city (Berlin Example)</p>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <div class="container my-5">
    
    <div v-if="step === 'dashboard'">
       <h2 class="mb-4">My Bookings</h2>
       <button class="btn btn-outline-secondary mb-4" @click="step=0">&larr; Back Home</button>
       
       <div v-if="myBookings.length === 0" class="alert alert-info">No bookings found.</div>
       
       <div class="card mb-3 p-3 shadow-sm border-0" v-for="b in myBookings" :key="b._id">
          <div class="d-flex justify-content-between align-items-center">
             <div>
               <h5 class="mb-1 text-primary">{{ b.roomId?.type || 'Room' }}</h5>
               <small class="text-muted">
                 {{ new Date(b.checkIn).toLocaleDateString() }} - {{ new Date(b.checkOut).toLocaleDateString() }}
               </small>
               <div class="mt-2"><span class="badge bg-success">{{ b.status }}</span></div>
             </div>
             <div class="text-end">
               <div class="fs-4 fw-bold">${{ b.totalPrice }}</div>
               <small>{{ b.guests }} Guests</small>
             </div>
          </div>
       </div>
    </div>

    <div v-if="step === 1">
      <div class="text-center mb-5">
        <h2>Accommodations</h2>
        <div style="width: 50px; height: 3px; background: var(--primary-gold); margin: 0 auto;"></div>
      </div>

      <div class="row g-3 mb-5 justify-content-center">
         <div class="col-md-4">
           <input v-model="filters.search" class="form-control" placeholder="Search rooms...">
         </div>
         <div class="col-md-3">
           <select v-model="filters.sort" class="form-select">
             <option value="asc">Price: Low to High</option>
             <option value="desc">Price: High to Low</option>
           </select>
         </div>
      </div>

      <div class="row g-4">
        <div class="col-lg-4 col-md-6" v-for="room in filteredRooms" :key="room._id">
          <div class="room-card d-flex flex-column">
            <div class="position-relative">
              <img :src="room.image || 'https://via.placeholder.com/400x250'" style="height:240px; width:100%; object-fit:cover" @error="$event.target.src='https://via.placeholder.com/400'">
              <span v-if="room.discount" class="position-absolute top-0 end-0 bg-dark text-white px-3 py-1 m-3 small">-{{ room.discount }}%</span>
            </div>
            <div class="p-4 d-flex flex-column flex-grow-1">
              <h4 class="mb-2">{{ room.type }}</h4>
              <p class="text-muted mb-4 flex-grow-1">Luxury and comfort combined.</p>
              <div class="mt-auto d-flex justify-content-between align-items-center pt-3 border-top">
                <span class="fs-4 fw-bold text-dark">${{ room.fullPrice }}</span>
                <button class="btn btn-outline-gold px-4" @click="selectRoom(room)">SELECT</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div v-if="step === 2">
      <button class="btn btn-link text-muted mb-4 ps-0" @click="step = 1">&larr; Back</button>
      <div class="row g-5">
        <div class="col-lg-7">
          <h3 class="mb-4">Details</h3>
          <div class="row g-3">
             <div class="col-md-6"><label>Full Name</label><input v-model="form.name" class="form-control"></div>
             <div class="col-md-6"><label>Email</label><input v-model="form.email" class="form-control"></div>
             <div class="col-md-4"><label>Check-In</label><input v-model="form.checkIn" type="date" class="form-control" :min="minDate"></div>
             <div class="col-md-4"><label>Check-Out</label><input v-model="form.checkOut" type="date" class="form-control" :min="form.checkIn"></div>
             <div class="col-md-4"><label>Guests</label>
                <select v-model="form.guests" class="form-select"><option>1</option><option>2</option><option>3</option></select>
             </div>
          </div>
          <h3 class="mt-5 mb-3">Extras</h3>
          <div v-for="s in services" :key="s._id" class="p-3 border rounded mb-2 d-flex justify-content-between cursor-pointer" 
               :class="{'bg-light border-warning': selectedServices.includes(s)}" @click="toggleService(s)">
            <span>{{ s.name }}</span><span>+${{ s.price }}</span>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="summary-box">
             <h4>Summary</h4>
             <p><strong>{{ selectedRoom.type }}</strong></p>
             <div class="d-flex justify-content-between"><span>Room</span><span>${{ selectedRoom.fullPrice * nights }}</span></div>
             <div v-for="s in selectedServices" class="d-flex justify-content-between text-muted"><span>{{ s.name }}</span><span>+${{ s.price }}</span></div>
             <hr>
             <div class="d-flex justify-content-between fs-4 fw-bold"><span>Total</span><span>${{ totalPrice }}</span></div>
             <button class="btn btn-gold w-100 mt-4 py-3" @click="submitBooking">CONFIRM BOOKING</button>
          </div>
        </div>
      </div>
    </div>

    <div v-if="step === 3" class="text-center py-5">
       <h1 class="text-success display-1"><i class="bi bi-check-circle"></i></h1>
       <h2>Confirmed!</h2>
       <p>Thank you {{ form.name }}.</p>
       <button class="btn btn-outline-dark mt-4" @click="step=0">Back Home</button>
    </div>

  </div>
  
  <footer class="bg-dark text-white py-5 mt-5 text-center">
     <h3>GRAND PALACE</h3>
     <p class="text-white-50">&copy; 2024 Grand Palace Hotel.</p>
  </footer>

</div>
<script>
  const { createApp } = Vue;
  createApp({
    data() {
      return {
        step: 0,
        rooms: [], services: [], myBookings: [],
        selectedRoom: null, selectedServices: [],
        minDate: new Date().toISOString().split('T')[0],
        filters: { search: '', sort: 'asc' },
        form: { name: '', email: '', checkIn: '', checkOut: '', guests: 1 },
        user: null, showAuthModal: false, authMode: 'login',
        authForm: { username: '', email: '', password: '' },
        mapInstance: null // ذخیره اینستنس نقشه
      };
    },
    computed: {
      nights() {
        if(!this.form.checkIn || !this.form.checkOut) return 1;
        const d = Math.ceil((new Date(this.form.checkOut) - new Date(this.form.checkIn)) / 86400000);
        return d > 0 ? d : 1;
      },
      totalPrice() {
        if(!this.selectedRoom) return 0;
        return (this.selectedRoom.fullPrice * this.nights) + this.selectedServices.reduce((a, b) => a + b.price, 0);
      },
      filteredRooms() {
        let r = this.rooms.filter(room => room.type.toLowerCase().includes(this.filters.search.toLowerCase()));
        if(this.filters.sort === 'asc') r.sort((a,b) => a.fullPrice - b.fullPrice);
        else r.sort((a,b) => b.fullPrice - a.fullPrice);
        return r;
      }
    },
    // تماشای تغییرات step برای لود مجدد نقشه
    watch: {
      step(newVal) {
        if (newVal === 0) {
          this.initMap();
        }
      }
    },
    async mounted() {
      // 1. ابتدا نقشه را لود کن (مستقل از سرور)
      this.initMap();

      // 2. لود اطلاعات کاربر از حافظه
      const token = localStorage.getItem('token');
      const savedUser = localStorage.getItem('user');
      if(token && savedUser) this.user = JSON.parse(savedUser);

      // 3. درخواست به سرور (با مدیریت خطا)
      try {
        const [r, s] = await Promise.all([fetch('/api/rooms'), fetch('/api/services')]);
        if(r.ok) this.rooms = await r.json();
        if(s.ok) this.services = await s.json();
      } catch(e) { 
        console.log('Server connection failed, but map should still work.'); 
      }
    },
    methods: {
      initMap() {
        // استفاده از nextTick تا مطمئن شویم HTML رندر شده است
        this.$nextTick(() => {
           const mapContainer = document.getElementById('map');
           
           // اگر کانتینر نقشه وجود داشت
           if(mapContainer) {
             // اگر نقشه قبلی وجود دارد، آن را پاک کن تا ارور ندهد
             if (this.mapInstance) {
               this.mapInstance.remove();
               this.mapInstance = null;
             }

             // ساخت نقشه جدید
             this.mapInstance = L.map('map').setView([52.5200, 13.4050], 13);
             
             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                 attribution: '&copy; OpenStreetMap contributors'
             }).addTo(this.mapInstance);
             
             L.marker([52.5200, 13.4050]).addTo(this.mapInstance)
               .bindPopup('<b>Grand Palace Hotel</b><br>Berlin, Germany').openPopup();
               
             // ترفند برای رندر صحیح تایل‌ها در برخی مرورگرها
             setTimeout(() => { this.mapInstance.invalidateSize(); }, 200);
           }
        });
      },
      
      // --- Auth Methods ---
      async authenticate() {
        try {
          const url = this.authMode === 'login' ? '/api/auth/login' : '/api/auth/register';
          const res = await fetch(url, {
             method: 'POST', headers: {'Content-Type': 'application/json'},
             body: JSON.stringify(this.authForm)
          });
          const data = await res.json();
          if(res.ok && data.token) {
             this.user = data.user;
             localStorage.setItem('token', data.token);
             localStorage.setItem('user', JSON.stringify(data.user));
             this.showAuthModal = false;
             this.form.name = this.user.username;
             this.form.email = this.user.email;
          } else {
             alert(data.msg || 'Authentication failed');
          }
        } catch(e) { alert('Server error'); }
      },
      logout() {
        this.user = null;
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        this.step = 0;
      },
      async fetchMyBookings() {
        const token = localStorage.getItem('token');
        if(!token) return;
        const res = await fetch('/api/my-bookings', { headers: { 'Authorization': 'Bearer ' + token } });
        if(res.ok) {
           this.myBookings = await res.json();
           this.step = 'dashboard';
        }
      },

      // --- Booking Methods ---
      selectRoom(r) { 
        this.selectedRoom = r; this.step = 2; 
        this.form.checkIn = this.minDate; 
        const t = new Date(); t.setDate(t.getDate()+1);
        this.form.checkOut = t.toISOString().split('T')[0];
        window.scrollTo(0,0);
      },
      toggleService(s) {
        if(this.selectedServices.includes(s)) this.selectedServices = this.selectedServices.filter(x=>x._id!==s._id);
        else this.selectedServices.push(s);
      },
      async submitBooking() {
        if(!this.form.name || !this.form.email) return alert('Details required');
        const token = localStorage.getItem('token');
        
        try {
          const res = await fetch('/api/bookings', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              token: token,
              guestName: this.form.name, guestEmail: this.form.email,
              roomId: this.selectedRoom._id, checkIn: this.form.checkIn, checkOut: this.form.checkOut,
              nights: this.nights, guests: this.form.guests,
              totalPrice: this.totalPrice, services: this.selectedServices.map(s=>s.name)
            })
          });
          if(res.ok) {
            this.step = 3; window.scrollTo(0,0);
          } else {
            alert('Booking failed');
          }
        } catch(e) { alert('Error submitting booking'); }
      }
    }
  }).mount('#app');
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>